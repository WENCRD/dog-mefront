import { useEffect, useState } from "react";
import { useNavigate } from "react-router-dom";
import FadeInSection from "../components/scroll";
import { Swiper, SwiperSlide } from "swiper/react";
import { Autoplay, Pagination, Navigation } from "swiper/modules";
import { getGalleryImages } from "../services/api";
import "../HomePage.css";

const HomePage = () => {
  const [modalImage, setModalImage] = useState<string | null>(null);
  const closeModal = () => setModalImage(null);
  const navigate = useNavigate();
  const [isVisible, setIsVisible] = useState(false);
  const [modalPrestation, setModalPrestation] = useState<string | null>(null);
  const openPrestationModal = (type: string) => {
    setModalPrestation(type);
    setActiveCard(type); // force le visuel actif quand on clique
  };  
  const closePrestationModal = () => {
    setModalPrestation(null);
  };

  const [dynamicImages, setDynamicImages] = useState<string[]>([]);
  useEffect(() => {
    getGalleryImages()
      .then(setDynamicImages)
      .catch(() => console.error("Erreur chargement images"));
  }, []);

  const [activeCard, setActiveCard] = useState<string | null>(null);
 
  
  useEffect(() => {
    const handleCustomScroll = () => {
      const searchParams = new URLSearchParams(window.location.search);
      const targetId = searchParams.get("scrollTo");
  
      if (targetId) {
        const target = document.getElementById(targetId);
        if (target) {
          const yOffset = -150;
          const y = target.getBoundingClientRect().top + window.scrollY + yOffset;
  
          window.scrollTo({ top: y, behavior: "smooth" });
          setActiveCard(targetId);
        }
      }
    };
  
    window.addEventListener("locationchange", handleCustomScroll);
    handleCustomScroll(); 
  
    return () => window.removeEventListener("locationchange", handleCustomScroll);
  }, []);

  const handleClick = () => {
  if (window.location.pathname === "/") {
    const params = new URLSearchParams(window.location.search);
    params.set("scrollTo", "services");
    const newUrl = `${window.location.pathname}?${params.toString()}`;
    window.history.pushState({}, "", newUrl);
    window.dispatchEvent(new Event("locationchange"));
  } else {
    navigate("/services");
  }
};
  
  

 const images = dynamicImages.length > 0 ? dynamicImages : [
    "/img/dogd.jpeg",
    "/img/dogd.jpeg",
    "/img/dogd.jpeg",
    "/img/dogd.jpeg",
    "/img/dogd.jpeg",
    "/img/dogd.jpeg",
    "/img/dogd.jpeg",
    "/img/dogd.jpeg",
  ];

  useEffect(() => {
    const handleScroll = () => {
      setIsVisible(window.scrollY > 300);
    };
    window.addEventListener("scroll", handleScroll);
    return () => window.removeEventListener("scroll", handleScroll);
  }, []);

  useEffect(() => {
    const script = document.createElement("script");
    script.src = "https://static.elfsight.com/platform/platform.js";
    script.async = true;
    document.body.appendChild(script);
  }, []);

  return (
    <div>
      {/* Hero Section */}
      <header className="img">
        <div className="hero-content">
          <h1 className="head-title">√âDUCATEUR CANIN</h1>
          <p className="hero-description">
            Offrez √† votre chien une √©ducation personnalis√©e et bienveillante.
          </p>
          <div className="button-container">
            <button className="btnhp"onClick={handleClick}>
              LES PRESTATIONS
            </button>
            <button className="btnhp" onClick={() => navigate("/contact")}>
              ME CONTACTER
            </button>
          </div>
        </div>
      </header>

     <div className="floating-buttons">
  {/* T√©l√©phone */}
  <a href="tel:+33612345678" className="floating-btn" aria-label="T√©l√©phoner">
    <i className="fas fa-phone"></i>
  </a>

  {/* TikTok */}
  <a href="https://www.tiktok.com/@remy_dogandme" target="_blank" className="floating-btn" aria-label="TikTok">
    <i className="fab fa-tiktok"></i>
  </a>

  {/* Instagram */}
  <a href="https://www.instagram.com/remy_dogandme/" target="_blank" className="floating-btn" aria-label="Instagram">
    <i className="fab fa-instagram"></i>
  </a>
</div>


      {/* Navigation ‚Äì √† personnaliser */}
      <nav className="navbare">
        <div className="section-nav">          
        </div>
      </nav>

      {/* === Galerie Swiper === */}
      <section className="section-container gallery-slider">
        <Swiper
          modules={[Autoplay, Pagination, Navigation]}
          spaceBetween={4}
          slidesPerView={1}
          loop
          autoplay={{ delay: 2000, disableOnInteraction: false }}
          pagination={{ clickable: true }}
          navigation
          breakpoints={{
            640: { slidesPerView: 2 },
            1024: { slidesPerView: Math.min(4, images.length) },
          }}
        >
          {images.map((img, index) => (
            <SwiperSlide key={index}>
              <img
                src={img}
                alt={`Slide ${index + 1}`}
                onClick={() => setModalImage(img)}
                className="swiper-image"
              />
            </SwiperSlide>
          ))}
        </Swiper>
        {modalImage && (
          <div className="image-modal" onClick={closeModal}>
            <img src={modalImage} alt="Aper√ßu plein √©cran" />
          </div>
        )}
      </section>

      <FadeInSection>
        <section className="section-container">
          <div className="content-wrapper">
            <img className="img-left" src="/img/Remy.jpg" alt="Pourquoi choisir l'√©ducation canine" />
            <div className="text-right">
              <h2>Qui suis-je/ Mon parcours</h2>
              <p>
                Bonjour et bienvenue, je m'appelle R√©my, √¢g√© de 33 ans, amoureux des animaux depuis tout petit.
                <br />
                J'ai d√©cid√© en 2022 de devenir √©ducateur canin comportementaliste, form√© par Chlo√© Fesch chez
                <a href="https://naturedechien.fr" target="_blank" rel="noopener noreferrer">
                  <strong> Nature de Chien</strong>
                </a> √† Toulouse.
                <br />
                Afin de me perfectionner sur certaines notions, j'ai suivi un stage chez mon coll√®gue Florian, fondateur de
                <a href="https://paws-up.fr" target="_blank" rel="noopener noreferrer">
                  <strong> Paws Up</strong>
                </a>.
                <br />
                Avant cette remise en question qui a d√©clench√© ma reconversion, j'ai r√©alis√© plusieurs petits boulots en int√©rim
                et j'ai √©t√© responsable magasin dans la vente de pi√®ces auto pendant sept ans.
              </p>
            </div>
          </div>
        </section>
      </FadeInSection>

      <FadeInSection>
        <section className="section-container">
          <div className="two-columns">
            <div className="image-block">
              <img src="/img/dg.jpeg" alt="Chien √©ducatif 1" className="side-image" />
              <h2>ULKA</h2>
              <p className="image-caption">
                jeune Husky de 15 mois tr√®s dynamique toujours √† la recherche de nouveaux amis "chiens comme humains",
                participe √† certaines s√©ances individuelles ou lors des sessions de cani-randos.
              </p>
            </div>
            <div className="image-block">
              <img src="/img/myst.jpeg" alt="Chien √©ducatif 2" className="side-image" />
              <h2>MYSTIQUE</h2>
              <p className="image-caption">
                berger blanc suisse de 8 ans, quoi dire de plus que si aujourd'hui j'ai pris la decision d'√™tre √©ducateur canin
                c'est gr√¢ce √† elle ; participe tr√®s rarement aux s√©ances individuelles et de temps en temps aux cani-randos, tout d√©pend des circonstances.
              </p>
            </div>
          </div>
        </section>
      </FadeInSection>

      <FadeInSection>
      <section className="section-container">
        <h2  id="services">LES PRESTATIONS</h2>
  <div className="content-wrapper prestations-grid">
    {/* PROMENADE */}
    <div
      className={`prestation-card${activeCard === "promenade" ? " active" : ""}`}
      id="promenade"
      onClick={() => {
        setActiveCard("promenade");
        openPrestationModal("promenade");
      }}
      style={{ cursor: "pointer" }}
    >
      <h3>üö∂‚Äç‚ôÇÔ∏è Promenade p√©dagogique</h3>
      <p>
        Dur√©e : 1h - 1h30<br />
        Une sortie ludique incluant jeux et interactions. Id√©al pour les journ√©es charg√©es.
        <br />
        <em>(Ne remplace pas une s√©ance √©ducative.)</em>
      </p>
      <p className="prix">30‚Ç¨</p> 
      <button
        className="btn-en-savoir-plus"
        onClick={(e) => {
          e.stopPropagation(); // √©vite le double d√©clenchement
          openPrestationModal("promenade");
        }}
      >
        <i className="fas fa-paw"></i> En savoir plus</button>
    </div>

    {/* BILAN */}
    <div
      className={`prestation-card${activeCard === "bilan" ? " active" : ""}`}
      id="bilan"
      onClick={() => {
        setActiveCard("bilan");
        openPrestationModal("bilan");
      }}
      style={{ cursor: "pointer" }}
    >
      <h3>üß† Bilan comportemental</h3>
      <p>
        Dur√©e : ~2h, chez vous.
        <br />
        On fait connaissance, on identifie les besoins, et on pose les bases d‚Äôune m√©thode adapt√©e √† votre bin√¥me.
      </p>
      <p className="prix">100‚Ç¨</p>
      <button
        className="btn-en-savoir-plus"
        onClick={(e) => {
          e.stopPropagation();
          openPrestationModal("bilan");
        }}
      >
        <i className="fas fa-paw"></i> En savoir plus
      </button>
    </div>

    {/* INDIVIDUELLE */}
    <div
      className={`prestation-card${activeCard === "seance" ? " active" : ""}`}
      id="seance"
      onClick={() => {
        setActiveCard("seance");
        openPrestationModal("seance");
      }}
      style={{ cursor: "pointer" }}
    >
      <h3>üéØ S√©ance individuelle</h3>
      <p>
        Travail √©ducatif cibl√© pour aider votre chien √† s‚Äôadapter sereinement √† son environnement.
      </p>
      <p className="prix">50‚Ç¨</p>
      <button
        className="btn-en-savoir-plus"
        onClick={(e) => {
          e.stopPropagation();
          openPrestationModal("seance");
        }}
      >
        <i className="fas fa-paw"></i> En savoir plus
      </button>
    </div>

    {/* FORFAIT */}
    <div
      className={`prestation-card${activeCard === "forfait" ? " active" : ""}`}
      id="forfait"
      onClick={() => {
        setActiveCard("forfait");
        openPrestationModal("forfait");
      }}
      style={{ cursor: "pointer" }}
    >
      <h3>üì¶ Forfait 4 s√©ances</h3>
      <p>
        4 s√©ances individuelles espac√©es, pour travailler progressivement sur plusieurs probl√©matiques.
      </p>
      <p className="prix">150‚Ç¨</p>
      <button
        className="btn-en-savoir-plus"
        onClick={(e) => {
          e.stopPropagation();
          openPrestationModal("forfait");
        }}
      >
        <i className="fas fa-paw"></i> En savoir plus
      </button>
    </div>
  </div>
</section>

      </FadeInSection>

      <FadeInSection>
        <section className="section-container temoignages-section">
          <div className="temoignages-inner">
            <div className="google-reviews-widget">
              <div
                className="elfsight-app-32400789-c253-4459-985e-55f3233ae3ae"
                data-elfsight-app-lazy
              ></div>
            </div>
          </div>
        </section>
      </FadeInSection>

      <FadeInSection>
      <section className="section-container contact-cta">
  <div className="content-wrapper">
    <h2>üí¨ Une question ? Un doute ?</h2>
    <p>N‚Äôh√©sitez pas √† me contacter, je suis l√† pour vous accompagner avec votre loulou üêæ</p>
    <a href="/contact" className="cta-button">Me contacter</a>
  </div>
</section>

      </FadeInSection>

  {isVisible && (
  <button
    onClick={() => window.scrollTo({ top: 0, behavior: "smooth" })}
    className="scroll-to-top visible"
    aria-label="Retour en haut"
  >
    <i className="fas fa-arrow-up" aria-hidden="true"></i>
  </button>
)}



{modalPrestation && (
  <div className="modal-overlay" onClick={closePrestationModal}>
    <div className="modal-content" onClick={(e) => e.stopPropagation()}>
      <button className="modal-close" onClick={closePrestationModal}>√ó</button>

      {modalPrestation === "promenade" && (
        <div>
          <h2>üö∂‚Äç‚ôÇÔ∏è Promenade p√©dagogique</h2>
          <img src="/img/BC.jpg" alt="Promenade p√©dagogique" className="modal-img" />
          <p>
            Une balade √©ducative pour que votre loulou üê∂ puisse se d√©fouler et apprendre √† son rythme. On combine jeux, marche en laisse, socialisation et rappel, toujours dans la bonne humeur !<br /><br />
            <strong>Dur√©e :</strong> 1h √† 1h30<br />
            <strong>Tarif :</strong> 30‚Ç¨<br />
          </p>
          <a href="tel:+33611810229" className="btn-contact-modal">üìû Me contacter</a>
        </div>
      )}

      {modalPrestation === "bilan" && (
        <div>
          <h2>üß† Bilan comportemental</h2>
          <img src="/img/BL.jpg" alt="Bilan comportemental" className="modal-img" />
          <p>
            Un moment d‚Äô√©change √† la maison pour mieux comprendre votre loulou, son quotidien, ses √©motions et ses besoins. On √©tablit ensemble une base √©ducative solide adapt√©e √† votre bin√¥me üêæ<br /><br />
            <strong>Dur√©e :</strong> environ 2h<br />
            <strong>Tarif :</strong> 100‚Ç¨<br />
          </p>
          <a href="tel:+33611810229" className="btn-contact-modal">üìû Me contacter</a>
        </div>
      )}

      {modalPrestation === "seance" && (
        <div>
          <h2>üéØ S√©ance individuelle</h2>
          <img src="/img/PP.jpg" alt="S√©ance individuelle" className="modal-img" />
          <p>
            Une s√©ance personnalis√©e pour travailler ce qui pose souci : rappel, marche en laisse, aboiements, gestion des √©motions... Le tout en douceur et avec le sourire üêï<br /><br />
            <strong>Dur√©e :</strong> ~1h<br />
            <strong>Tarif :</strong> 50‚Ç¨<br />
          </p>
          <a href="tel:+33611810229" className="btn-contact-modal">üìû Me contacter</a>
        </div>
      )}

      {modalPrestation === "forfait" && (
        <div>
          <h2>üì¶ Forfait 4 s√©ances</h2>
          <img src="/img/4F.jpg" alt="Forfait 4 s√©ances" className="modal-img" />
          <p>
            Pour prendre le temps d‚Äôapprendre en confiance. 4 s√©ances progressives pour accompagner votre loulou sur le long terme, et renforcer votre complicit√© √©tape par √©tape üê∂üíõ<br /><br />
            <strong>Dur√©e :</strong> 4 s√©ances individuelles<br />
            <strong>Tarif :</strong> 150‚Ç¨<br />
          </p>
          <a href="tel:+33611810229" className="btn-contact-modal">üìû Me contacter</a>
        </div>
      )}
    </div>
  </div>
)}

    </div>
  );
};

export default HomePage;
